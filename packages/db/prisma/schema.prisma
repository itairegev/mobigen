generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  image         String?
  passwordHash  String?   @map("password_hash")
  tier          String    @default("basic")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts           Account[]
  sessions           Session[]
  projects           Project[]
  usageEvents        UsageEvent[]
  githubConnections  GitHubConnection[]
  publishedTemplates TemplateMarketplace[]
  templatePurchases  TemplatePurchase[]
  templateReviews    TemplateReview[]
  ownerApiKeys       OwnerApiKey[]
  teamMemberships    TeamMember[]       @relation("TeamMemberUser")
  teamInvitations    TeamMember[]       @relation("TeamMemberInviter")

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Project {
  id         String  @id @default(uuid())
  userId     String  @map("user_id")
  name       String
  templateId String? @map("template_id")
  status     String  @default("draft")
  config     Json    @default("{}")

  bundleIdIos     String? @map("bundle_id_ios")
  bundleIdAndroid String? @map("bundle_id_android")
  branding        Json    @default("{}")

  s3Bucket String @map("s3_bucket")
  s3Prefix String @map("s3_prefix")

  currentVersion Int @default(1) @map("current_version")

  claudeSessionId  String?   @map("claude_session_id")
  sessionExpiresAt DateTime? @map("session_expires_at")

  lastAccessedAt DateTime @default(now()) @map("last_accessed_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user        User             @relation(fields: [userId], references: [id])
  sessions    ProjectSession[]
  changes     ProjectChange[]
  builds      Build[]
  usageEvents UsageEvent[]
  teamMembers TeamMember[]

  @@index([userId])
  @@index([lastAccessedAt])
  @@map("projects")
}

model ProjectSession {
  id              String    @id @default(uuid())
  projectId       String    @map("project_id")
  claudeSessionId String    @map("claude_session_id")
  summary         String?
  filesModified   String[]  @map("files_modified")
  tokensUsed      Int       @default(0) @map("tokens_used")
  durationSeconds Int       @default(0) @map("duration_seconds")
  createdAt       DateTime  @default(now()) @map("created_at")
  endedAt         DateTime? @map("ended_at")

  project Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  changes ProjectChange[]

  @@index([projectId])
  @@map("project_sessions")
}

model ProjectChange {
  id            String   @id @default(uuid())
  projectId     String   @map("project_id")
  sessionId     String?  @map("session_id")
  version       Int
  message       String
  changeType    String?  @map("change_type")
  filesAdded    String[] @map("files_added")
  filesModified String[] @map("files_modified")
  filesDeleted  String[] @map("files_deleted")
  s3SnapshotKey String?  @map("s3_snapshot_key")
  isRevertible  Boolean  @default(true) @map("is_revertible")
  createdAt     DateTime @default(now()) @map("created_at")

  project Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  session ProjectSession? @relation(fields: [sessionId], references: [id])

  @@unique([projectId, version])
  @@index([projectId])
  @@map("project_changes")
}

model Build {
  id                String    @id @default(uuid())
  projectId         String    @map("project_id")
  version           Int
  platform          String
  status            String
  easBuildId        String?   @map("eas_build_id")
  easProjectId      String?   @map("eas_project_id")
  artifactS3Key     String?   @map("artifact_s3_key")
  artifactSizeBytes BigInt?   @map("artifact_size_bytes")
  logsS3Key         String?   @map("logs_s3_key")
  errorSummary      String?   @map("error_summary")
  validationTier    String?   @map("validation_tier")
  validationPassed  Boolean?  @map("validation_passed")
  validationErrors  Json?     @map("validation_errors")
  startedAt         DateTime? @map("started_at")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@map("builds")
}

model UsageEvent {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  projectId   String?  @map("project_id")
  eventType   String   @map("event_type")
  creditsUsed Int      @default(0) @map("credits_used")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("usage_events")
}

model Generation {
  id           String    @id @default(uuid())
  projectId    String    @map("project_id")
  status       String    @default("pending")
  phase        String?
  progress     Int       @default(0)
  metadata     Json      @default("{}")
  errorMessage String?   @map("error_message")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([projectId])
  @@index([status])
  @@map("generations")
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  event     String
  userId    String?  @map("user_id")
  projectId String?  @map("project_id")
  metadata  Json     @default("{}")
  timestamp DateTime @default(now())

  @@index([event])
  @@index([userId])
  @@index([timestamp])
  @@map("analytics_events")
}

model ApiUsage {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  projectId    String?  @map("project_id")
  model        String
  inputTokens  Int      @map("input_tokens")
  outputTokens Int      @map("output_tokens")
  requestId    String?  @map("request_id")
  timestamp    DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([timestamp])
  @@index([model])
  @@map("api_usage")
}

model TestResult {
  id        String   @id @default(uuid())
  buildId   String   @map("build_id")
  name      String
  status    String
  duration  Int
  error     String?
  steps     Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([buildId])
  @@map("test_results")
}

model Screenshot {
  id         String   @id @default(uuid())
  buildId    String   @map("build_id")
  screen     String
  platform   String
  url        String
  width      Int
  height     Int
  isBaseline Boolean  @default(false) @map("is_baseline")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([buildId])
  @@map("screenshots")
}

// ============================================================================
// TASK TRACKING FOR GENERATION PIPELINE
// ============================================================================

model GenerationJob {
  id             String    @id @default(uuid())
  projectId      String    @map("project_id")
  status         String    @default("pending") // pending, running, completed, failed, paused
  currentPhase   String?   @map("current_phase")
  currentAgent   String?   @map("current_agent")
  totalTasks     Int       @default(0) @map("total_tasks")
  completedTasks Int       @default(0) @map("completed_tasks")
  failedTasks    Int       @default(0) @map("failed_tasks")
  progress       Int       @default(0) // 0-100 percentage
  errorMessage   String?   @map("error_message")
  retryCount     Int       @default(0) @map("retry_count")
  maxRetries     Int       @default(3) @map("max_retries")
  metadata       Json      @default("{}")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  tasks GenerationTask[]

  @@index([projectId])
  @@index([status])
  @@map("generation_jobs")
}

model GenerationTask {
  id            String    @id @default(uuid())
  jobId         String    @map("job_id")
  projectId     String    @map("project_id")
  phase         String // analysis, planning, architecture, design, implementation, validation, qa
  agentId       String    @map("agent_id")
  taskType      String    @map("task_type") // agent_execution, validation, fix_attempt
  status        String    @default("pending") // pending, running, completed, failed, skipped
  priority      Int       @default(0) // Higher = run first
  dependsOn     String[]  @default([]) @map("depends_on") // Task IDs this depends on
  input         Json      @default("{}") // Task input/context
  output        Json? // Task result
  errorMessage  String?   @map("error_message")
  errorDetails  Json?     @map("error_details") // Structured error info for auto-fix
  retryCount    Int       @default(0) @map("retry_count")
  filesModified String[]  @default([]) @map("files_modified")
  durationMs    Int?      @map("duration_ms")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  job GenerationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([projectId])
  @@index([status])
  @@index([phase])
  @@map("generation_tasks")
}

// ============================================================================
// GITHUB INTEGRATION
// ============================================================================

model GitHubConnection {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  githubId       Int       @map("github_id")
  username       String
  email          String?
  avatarUrl      String?   @map("avatar_url")
  accessToken    String    @map("access_token") @db.Text
  refreshToken   String?   @map("refresh_token") @db.Text
  tokenExpiresAt DateTime? @map("token_expires_at")
  scopes         String[]  @default([])
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectConfigs ProjectGitHubConfig[]

  @@unique([userId, githubId])
  @@index([userId])
  @@map("github_connections")
}

model ProjectGitHubConfig {
  id            String    @id @default(uuid())
  projectId     String    @unique @map("project_id")
  connectionId  String    @map("connection_id")
  repoOwner     String    @map("repo_owner")
  repoName      String    @map("repo_name")
  defaultBranch String    @default("main") @map("default_branch")
  syncEnabled   Boolean   @default(true) @map("sync_enabled")
  autoCommit    Boolean   @default(true) @map("auto_commit")
  commitPrefix  String    @default("[mobigen]") @map("commit_prefix")
  syncStatus    String    @default("idle") @map("sync_status") // idle, syncing, synced, failed
  lastSyncAt    DateTime? @map("last_sync_at")
  lastSyncError String?   @map("last_sync_error")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  connection  GitHubConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  syncHistory GitHubSyncHistory[]

  @@index([connectionId])
  @@map("project_github_configs")
}

model GitHubSyncHistory {
  id            String    @id @default(uuid())
  configId      String    @map("config_id")
  phase         String // setup, product-definition, architecture, ui-design, implementation, validation, quality-assurance
  commitSha     String?   @map("commit_sha")
  commitMessage String?   @map("commit_message")
  filesAdded    String[]  @default([]) @map("files_added")
  filesModified String[]  @default([]) @map("files_modified")
  filesDeleted  String[]  @default([]) @map("files_deleted")
  status        String    @default("pending") // pending, syncing, completed, failed
  errorMessage  String?   @map("error_message")
  durationMs    Int?      @map("duration_ms")
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")

  config ProjectGitHubConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([createdAt])
  @@map("github_sync_history")
}

// ============================================================================
// AWS BACKEND PROVISIONING
// ============================================================================

model ProjectBackend {
  id            String    @id @default(uuid())
  projectId     String    @unique @map("project_id")
  templateId    String    @map("template_id")
  status        String    @default("pending") // pending, provisioning, active, failed, deprovisioning, deprovisioned
  environment   String    @default("prod") // dev, staging, prod
  region        String    @default("us-east-1")

  // AWS Resource Identifiers
  tablePrefix   String    @map("table_prefix")
  tableNames    String[]  @default([]) @map("table_names")

  functionName  String?   @map("function_name")
  functionArn   String?   @map("function_arn")
  lambdaRoleArn String?   @map("lambda_role_arn")

  apiId         String?   @map("api_id")
  apiEndpoint   String?   @map("api_endpoint")
  apiKey        String?   @map("api_key") @db.Text
  apiKeyId      String?   @map("api_key_id")
  stageName     String?   @default("v1") @map("stage_name")

  // Pro tier: custom database URL
  customDbUrl   String?   @map("custom_db_url") @db.Text

  // Provisioning tracking
  provisionedAt   DateTime? @map("provisioned_at")
  deprovisionedAt DateTime? @map("deprovisioned_at")
  lastError       String?   @map("last_error")
  retryCount      Int       @default(0) @map("retry_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("project_backends")
}

model BackendProvisioningLog {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  operation   String // provision, deprovision, update
  step        String // create_tables, deploy_lambda, create_api, seed_data
  status      String // started, completed, failed
  message     String?
  details     Json     @default("{}")
  durationMs  Int?     @map("duration_ms")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([projectId])
  @@index([createdAt])
  @@map("backend_provisioning_logs")
}

// ============================================================================
// OTA (OVER-THE-AIR) UPDATES
// ============================================================================

model UpdateChannel {
  id             String    @id @default(uuid())
  projectId      String    @map("project_id")
  name           String // production, staging, development, beta
  description    String?
  isDefault      Boolean   @default(false) @map("is_default")

  // Runtime version targeting
  runtimeVersion String?   @map("runtime_version")

  // Branch name in Expo
  branchName     String    @map("branch_name")

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  updates        OTAUpdate[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("update_channels")
}

model OTAUpdate {
  id             String    @id @default(uuid())
  projectId      String    @map("project_id")
  channelId      String    @map("channel_id")
  version        Int // Incremental version number

  // Expo Updates integration
  updateId       String?   @map("update_id") // Expo update ID
  groupId        String?   @map("group_id") // Expo update group ID
  runtimeVersion String    @map("runtime_version")
  platform       String    @default("all") // ios, android, all

  // Content
  message        String // User-facing change description
  changeType     String?   @map("change_type") // feature, fix, style, content

  // Files changed (for tracking)
  filesModified  String[]  @default([]) @map("files_modified")

  // Rollout configuration
  status         String    @default("draft") // draft, published, active, rolled_back, archived
  rolloutPercent Int       @default(100) @map("rollout_percent") // 0-100

  // Metrics
  downloadCount  Int       @default(0) @map("download_count")
  errorCount     Int       @default(0) @map("error_count")

  // Rollback support
  canRollback    Boolean   @default(true) @map("can_rollback")
  rolledBackTo   String?   @map("rolled_back_to") // ID of update we rolled back to
  rolledBackAt   DateTime? @map("rolled_back_at")

  // Manifest URL (for direct download)
  manifestUrl    String?   @map("manifest_url")

  // Publishing info
  publishedBy    String?   @map("published_by") // User ID
  publishedAt    DateTime? @map("published_at")

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  channel        UpdateChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  metrics        OTAUpdateMetric[]

  @@unique([projectId, channelId, version])
  @@index([projectId])
  @@index([channelId])
  @@index([status])
  @@index([publishedAt])
  @@map("ota_updates")
}

model OTAUpdateMetric {
  id              String   @id @default(uuid())
  updateId        String   @map("update_id")

  // Metrics by platform and version
  platform        String
  appVersion      String   @map("app_version")

  // Counts
  successCount    Int      @default(0) @map("success_count")
  failureCount    Int      @default(0) @map("failure_count")
  rollbackCount   Int      @default(0) @map("rollback_count")

  // Performance
  avgDownloadTime Int?     @map("avg_download_time_ms") // milliseconds
  avgApplyTime    Int?     @map("avg_apply_time_ms") // milliseconds

  // Aggregation period
  date            DateTime @default(now())

  update          OTAUpdate @relation(fields: [updateId], references: [id], onDelete: Cascade)

  @@unique([updateId, platform, appVersion, date])
  @@index([updateId])
  @@index([date])
  @@map("ota_update_metrics")
}

model OTAUpdateEvent {
  id            String   @id @default(uuid())
  updateId      String   @map("update_id")

  // Event details
  eventType     String   @map("event_type") // download_start, download_complete, download_error, apply_start, apply_complete, apply_error, rollback
  platform      String
  appVersion    String   @map("app_version")
  deviceId      String?  @map("device_id") // Hashed device identifier

  // Error tracking
  errorMessage  String?  @map("error_message")
  errorStack    String?  @map("error_stack") @db.Text

  // Performance
  durationMs    Int?     @map("duration_ms")

  // Metadata
  metadata      Json     @default("{}")

  createdAt     DateTime @default(now()) @map("created_at")

  @@index([updateId])
  @@index([eventType])
  @@index([createdAt])
  @@map("ota_update_events")
}

model RollbackEvent {
  id            String   @id @default(uuid())
  projectId     String   @map("project_id")

  // Rollback details
  fromVersion   Int      @map("from_version")
  toVersion     Int      @map("to_version")
  fromUpdateId  String   @map("from_update_id")
  toUpdateId    String   @map("to_update_id")
  reason        String?

  // Execution details
  performedBy   String   @map("performed_by") // User ID
  performedAt   DateTime @map("performed_at")
  success       Boolean  @default(false)
  filesRestored Int      @default(0) @map("files_restored")
  durationMs    Int      @map("duration_ms")

  // Error tracking
  error         String?  @db.Text

  @@index([projectId])
  @@index([performedAt])
  @@index([success])
  @@map("rollback_events")
}

// ============================================================================
// TEMPLATE MARKETPLACE
// ============================================================================

model TemplateCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  templates TemplateMarketplace[]

  @@index([slug])
  @@index([sortOrder])
  @@map("template_categories")
}

model TemplateMarketplace {
  id              String   @id @default(uuid())

  // Template identification
  name            String
  slug            String   @unique
  templateId      String   @unique @map("template_id") // References templates/ directory
  version         String   @default("1.0.0")

  // Category
  categoryId      String?  @map("category_id")
  category        TemplateCategory? @relation(fields: [categoryId], references: [id])

  // Metadata
  shortDescription String  @map("short_description")
  fullDescription  String  @db.Text @map("full_description")
  features         String[] @default([])
  keywords         String[] @default([])
  tags             String[] @default([])

  // Pricing
  tier            String   @default("free") // free, premium, enterprise
  price           Int      @default(0) // in cents
  currency        String   @default("usd")
  stripePriceId   String?  @map("stripe_price_id")
  discountPercent Int      @default(0) @map("discount_percent")

  // Publisher info
  publisherId     String   @map("publisher_id")
  publisher       User     @relation(fields: [publisherId], references: [id])
  isOfficial      Boolean  @default(true) @map("is_official") // Mobigen official vs third-party

  // Revenue sharing (for future third-party templates)
  revenueSharePercent Int  @default(0) @map("revenue_share_percent")

  // Assets
  thumbnailUrl    String?  @map("thumbnail_url")
  previewImages   String[] @default([]) @map("preview_images")
  demoUrl         String?  @map("demo_url")
  videoUrl        String?  @map("video_url")

  // Statistics
  downloadCount   Int      @default(0) @map("download_count")
  purchaseCount   Int      @default(0) @map("purchase_count")
  averageRating   Float    @default(0) @map("average_rating")
  totalRatings    Int      @default(0) @map("total_ratings")

  // Status
  status          String   @default("draft") // draft, published, archived
  publishedAt     DateTime? @map("published_at")

  // Compatibility
  minExpoVersion  String?  @map("min_expo_version")
  minRNVersion    String?  @map("min_rn_version")
  platforms       String[] @default(["ios", "android"])

  // Template configuration
  capabilities    String[] @default([])
  requiredDeps    Json     @default("[]") @map("required_deps")
  optionalDeps    Json     @default("[]") @map("optional_deps")
  backendFeatures String[] @default([]) @map("backend_features")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  purchases TemplatePurchase[]
  reviews   TemplateReview[]

  @@index([categoryId])
  @@index([status])
  @@index([tier])
  @@index([publisherId])
  @@index([averageRating])
  @@index([downloadCount])
  @@map("template_marketplace")
}

model TemplatePurchase {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  templateId      String   @map("template_id")

  // Pricing at purchase time
  price           Int // in cents
  currency        String   @default("usd")
  discountApplied Int      @default(0) @map("discount_applied")
  finalPrice      Int      @map("final_price")

  // Payment
  stripePaymentId String?  @unique @map("stripe_payment_id")
  paymentStatus   String   @default("pending") // pending, succeeded, failed, refunded
  paymentMethod   String?  @map("payment_method")

  // License
  licenseKey      String   @unique @map("license_key")
  licenseType     String   @default("single") @map("license_type") // single, team, enterprise

  // Metadata
  metadata        Json     @default("{}")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user     User                @relation(fields: [userId], references: [id])
  template TemplateMarketplace @relation(fields: [templateId], references: [id])

  @@unique([userId, templateId])
  @@index([userId])
  @@index([templateId])
  @@index([paymentStatus])
  @@map("template_purchases")
}

model TemplateReview {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  templateId String   @map("template_id")

  // Review content
  rating     Int // 1-5
  title      String?
  comment    String?  @db.Text

  // Metadata
  isVerifiedPurchase Boolean @default(false) @map("is_verified_purchase")
  isPublished        Boolean @default(true) @map("is_published")

  // Helpful votes
  helpfulCount       Int     @default(0) @map("helpful_count")
  notHelpfulCount    Int     @default(0) @map("not_helpful_count")

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user     User                @relation(fields: [userId], references: [id])
  template TemplateMarketplace @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
  @@index([userId])
  @@index([templateId])
  @@index([rating])
  @@index([isPublished])
  @@map("template_reviews")
}

// ============================================================================
// APP STORE SUBMISSION (PHASE 1 MVP)
// ============================================================================

model SubmissionProgress {
  id        String   @id @default(uuid())
  projectId String   @unique @map("project_id")
  platform  String // ios, android, both

  // Checklist progress
  completedSteps String[]  @default([]) @map("completed_steps")
  totalSteps     Int       @default(0) @map("total_steps")
  currentStep    String?   @map("current_step")

  // Platform-specific status
  iosStatus     String @default("not_started") @map("ios_status") // not_started, in_progress, review, live, rejected
  androidStatus String @default("not_started") @map("android_status") // not_started, in_progress, review, live, rejected

  // App Store Connect metadata
  iosAppId          String? @map("ios_app_id")
  iosAppStoreUrl    String? @map("ios_app_store_url")
  iosReviewStatus   String? @map("ios_review_status")
  iosRejectionNotes String? @map("ios_rejection_notes") @db.Text

  // Google Play Console metadata
  androidPackageName String? @map("android_package_name")
  androidPlayStoreUrl String? @map("android_play_store_url")
  androidReviewStatus String? @map("android_review_status")
  androidRejectionNotes String? @map("android_rejection_notes") @db.Text

  // Asset tracking
  iconsGenerated       Boolean @default(false) @map("icons_generated")
  screenshotsGenerated Boolean @default(false) @map("screenshots_generated")
  metadataCompleted    Boolean @default(false) @map("metadata_completed")

  // Submission metadata
  appDescription      String? @db.Text @map("app_description")
  appKeywords         String[] @default([]) @map("app_keywords")
  appCategory         String? @map("app_category")
  privacyPolicyUrl    String? @map("privacy_policy_url")
  supportUrl          String? @map("support_url")
  marketingUrl        String? @map("marketing_url")

  // Submission dates
  iosSubmittedAt   DateTime? @map("ios_submitted_at")
  iosApprovedAt    DateTime? @map("ios_approved_at")
  androidSubmittedAt DateTime? @map("android_submitted_at")
  androidApprovedAt  DateTime? @map("android_approved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([iosStatus])
  @@index([androidStatus])
  @@map("submission_progress")
}

model StoreCredentials {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  platform  String // ios, android

  // Encrypted credentials (using AES-256-GCM)
  credentialsEncrypted String @map("credentials_encrypted") @db.Text
  credentialsIv        String @map("credentials_iv") // Initialization vector for decryption
  credentialsTag       String @map("credentials_tag") // Authentication tag

  // Credential metadata (not encrypted)
  credentialType String @map("credential_type") // app_store_connect_api_key, google_play_service_account, apple_developer_cert
  description    String?
  expiresAt      DateTime? @map("expires_at")

  // Access tracking
  lastAccessedAt DateTime? @map("last_accessed_at")
  accessCount    Int       @default(0) @map("access_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([userId])
  @@index([platform])
  @@map("store_credentials")
}

model AppMetadata {
  id        String @id @default(uuid())
  projectId String @unique @map("project_id")

  // App identity
  appName        String  @map("app_name")
  appSubtitle    String? @map("app_subtitle")
  promotionalText String? @map("promotional_text") @db.Text

  // Descriptions
  shortDescription String @map("short_description") @db.Text // 80 chars for Play Store
  fullDescription  String @map("full_description") @db.Text // 4000 chars

  // SEO & Discovery
  keywords String[] @default([])
  category String

  // URLs
  privacyPolicyUrl String  @map("privacy_policy_url")
  supportUrl       String  @map("support_url")
  marketingUrl     String? @map("marketing_url")

  // Contact
  supportEmail String  @map("support_email")
  supportPhone String? @map("support_phone")

  // Content rating
  contentRating   String? @map("content_rating") // 4+, 9+, 12+, 17+ (iOS), Everyone, Teen, Mature (Android)
  contentWarnings String[] @default([]) @map("content_warnings")

  // Screenshots and media
  iosScreenshots     Json @default("{}") @map("ios_screenshots") // { "6.5inch": [...urls], "5.5inch": [...urls] }
  androidScreenshots Json @default("{}") @map("android_screenshots") // { "phone": [...urls], "tablet": [...urls] }
  featureGraphic     String? @map("feature_graphic") // Android only

  // Release notes
  releaseNotes Json @default("{}") @map("release_notes") // { "1.0.0": "Initial release", ... }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@map("app_metadata")
}

// ============================================================================
// SLA MONITORING FOR ENTERPRISE USERS
// ============================================================================

model UptimeRecord {
  id              String    @id @default(uuid())
  serviceId       String    @map("service_id")
  serviceType     String    @map("service_type") // api, generator, builder, preview, analytics, database
  checkTimestamp  DateTime  @map("check_timestamp")
  isHealthy       Boolean   @map("is_healthy")
  responseTimeMs  Int?      @map("response_time_ms")
  statusCode      Int?      @map("status_code")
  region          String?
  errorMessage    String?   @map("error_message") @db.Text
  errorCode       String?   @map("error_code")
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([serviceId])
  @@index([serviceType])
  @@index([checkTimestamp])
  @@index([isHealthy])
  @@map("uptime_records")
}

model Incident {
  id                 String    @id @default(uuid())
  serviceId          String    @map("service_id")
  serviceType        String    @map("service_type")
  title              String
  description        String    @db.Text
  severity           String // critical, major, minor, info
  status             String // investigating, identified, monitoring, resolved
  affectedRegions    String[]  @default([]) @map("affected_regions")
  affectedUsers      Int?      @map("affected_users")
  impactDescription  String?   @map("impact_description") @db.Text
  detectedAt         DateTime  @map("detected_at")
  identifiedAt       DateTime? @map("identified_at")
  resolvedAt         DateTime? @map("resolved_at")
  durationMs         Int?      @map("duration_ms")
  rootCause          String?   @map("root_cause") @db.Text
  resolution         String?   @db.Text
  updates            Json      @default("[]")
  metadata           Json      @default("{}")
  createdAt          DateTime  @default(now()) @map("created_at")

  @@index([serviceId])
  @@index([serviceType])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@map("incidents")
}

model SLAReport {
  id                String   @id @default(uuid())
  generatedAt       DateTime @map("generated_at")
  periodStart       DateTime @map("period_start")
  periodEnd         DateTime @map("period_end")
  overallSLA        Float    @map("overall_sla")
  metSLATarget      Boolean  @map("met_sla_target")
  targetSLA         Float    @map("target_sla")
  services          Json     @default("[]")
  totalIncidents    Int      @map("total_incidents")
  totalDowntimeMs   Int      @map("total_downtime_ms")
  comparisonPeriod  Json?    @map("comparison_period")
  uptimeTrend       Float?   @map("uptime_trend")
  incidentTrend     Float?   @map("incident_trend")
  notableIncidents  Json     @default("[]") @map("notable_incidents")
  slaCreditsOwed    Json     @default("[]") @map("sla_credits_owed")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([periodStart])
  @@index([periodEnd])
  @@index([metSLATarget])
  @@map("sla_reports")
}

model SLAAlert {
  id           String    @id @default(uuid())
  timestamp    DateTime
  type         String // incident_detected, sla_breach, performance_degradation, incident_resolved
  severity     String // critical, major, minor, info
  serviceId    String    @map("service_id")
  serviceType  String    @map("service_type")
  incidentId   String?   @map("incident_id")
  title        String
  message      String    @db.Text
  recipients   String[]  @default([])
  sent         Boolean   @default(false)
  sentAt       DateTime? @map("sent_at")
  metadata     Json      @default("{}")

  @@index([timestamp])
  @@index([type])
  @@index([severity])
  @@index([serviceId])
  @@index([sent])
  @@map("sla_alerts")
}

// ============================================================================
// CONTENT MANAGEMENT (Owner Dashboard)
// ============================================================================

model ContentAuditLog {
  id           String    @id @default(uuid())
  projectId    String    @map("project_id")
  userId       String    @map("user_id")
  userName     String?   @map("user_name")
  action       String // create, update, delete, bulk_create, bulk_update, bulk_delete, import, export, restore
  resource     String // products, orders, rewards, etc.
  resourceId   String?   @map("resource_id")
  previousData Json?     @map("previous_data")
  newData      Json?     @map("new_data")
  bulkCount    Int?      @map("bulk_count")
  bulkIds      String[]  @default([]) @map("bulk_ids")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([projectId])
  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([createdAt])
  @@map("content_audit_logs")
}

model OwnerApiKey {
  id          String    @id @default(uuid())
  projectId   String    @map("project_id")
  userId      String    @map("user_id")
  name        String
  description String?
  keyHash     String    @map("key_hash") // SHA-256 hash of the API key
  keyPrefix   String    @map("key_prefix") // First 8 chars for identification (e.g., "mob_live_")
  permissions String[]  @default(["read"]) // read, write, delete, bulk, export, import
  resources   String[]  @default([]) // Empty = all resources, otherwise specific resource names
  rateLimit   Int       @default(100) @map("rate_limit") // Requests per minute
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  usageCount  Int       @default(0) @map("usage_count")
  revokedAt   DateTime? @map("revoked_at")
  revokedBy   String?   @map("revoked_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([keyPrefix])
  @@map("owner_api_keys")
}

model TeamMember {
  id         String    @id @default(uuid())
  projectId  String    @map("project_id")
  userId     String    @map("user_id")
  invitedBy  String    @map("invited_by")
  email      String // Email used for invitation
  role       String    @default("viewer") // owner, admin, editor, viewer
  status     String    @default("pending") // pending, accepted, declined, removed
  permissions String[] @default([]) // Custom permissions override (empty = role-based)
  inviteToken String?  @unique @map("invite_token") // For email invitations
  inviteExpiresAt DateTime? @map("invite_expires_at")
  acceptedAt DateTime? @map("accepted_at")
  removedAt  DateTime? @map("removed_at")
  removedBy  String?   @map("removed_by")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User    @relation("TeamMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  inviter    User    @relation("TeamMemberInviter", fields: [invitedBy], references: [id])

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([invitedBy])
  @@index([status])
  @@index([inviteToken])
  @@map("team_members")
}
